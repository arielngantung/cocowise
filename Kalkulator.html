<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator HPP - Sesuai Metode Excel (Versi Modifikasi)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Pustaka untuk membuat file Excel dengan Gaya (xlsx-js-style) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style/dist/xlsx.bundle.js"></script>
    <!-- Pustaka untuk membuat Grafik (Chart.js) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f9fafb;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-indicator.active {
            background-color: #16A34A; /* green-600 */
            color: white;
            border-color: #16A34A;
        }
        .step-indicator.completed {
            background-color: #10B981; /* emerald-500 */
            color: white;
            border-color: #10B981;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .product-cost-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

   <!-- Header -->
     <header class="bg-white/80 backdrop-blur-md fixed top-0 left-0 right-0 z-50 shadow-sm">
        <div class="w-full px-6 py-3 flex justify-between items-center">
           <a href="#">
                <img src="img/Logo1removbg.png" alt="CocoCost Logo" class="h-12 md:h-16">
            </a>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-gray-600 hover:text-green-600">Home</a>
                <a href="index.html" class="text-gray-600 hover:text-green-600">About</a>
                <a href="index.html#Contact" class="text-gray-600 hover:text-green-600">Contact</a>
                <a href="https://youtu.be/L8cFYm9Xr5c?feature=shared" target="_blank" class="text-gray-600 hover:text-green-600">Panduan</a>
            </nav>
            <!-- MobileMenuBtn -->
            <button id="mobile-menu-button" class="md:hidden ml-4 text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden px-6 pb-4">
            <a href="index.html" class="block py-2 text-gray-600 hover:text-green-600">Home</a>
            <a href="index.html" class="block py-2 text-gray-600 hover:text-green-600">About</a>
            <a href="index.html#Contact" class="block py-2 text-gray-600 hover:text-green-600">Contact</a>
            <a href="https://youtu.be/L8cFYm9Xr5c?feature=shared" target="_blank" class="block py-2 text-gray-600 hover:text-green-600">Panduan</a>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 max-w-6xl pt-24 relative z-10">
        <br> <br> <br>
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Kalkulator Harga Pokok Produksi</h1>
        </div>

        <!-- Step Indicator -->
        <div class="w-full max-w-4xl mx-auto mb-12">
            <div class="flex items-center justify-center">
                <div class="flex items-center flex-col md:flex-row">
                    <div id="step-indicator-1" class="step-indicator active flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 font-bold">1</div>
                    <p class="ml-0 md:ml-2 mt-1 md:mt-0 text-sm md:text-base">Produk</p>
                </div>
                <div class="flex-auto border-t-2 border-gray-300 mx-4"></div>
                <div class="flex items-center flex-col md:flex-row">
                    <div id="step-indicator-2" class="step-indicator flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 font-bold">2</div>
                    <p class="ml-0 md:ml-2 mt-1 md:mt-0 text-sm md:text-base">Biaya</p>
                </div>
                <div class="flex-auto border-t-2 border-gray-300 mx-4"></div>
                <div class="flex items-center flex-col md:flex-row">
                    <div id="step-indicator-3" class="step-indicator flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 font-bold">3</div>
                    <p class="ml-0 md:ml-2 mt-1 md:mt-0 text-sm md:text-base">Alokasi BOP</p>
                </div>
                <div class="flex-auto border-t-2 border-gray-300 mx-4"></div>
                <div class="flex items-center flex-col md:flex-row">
                    <div id="step-indicator-4" class="step-indicator flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <p class="ml-0 md:ml-2 mt-1 md:mt-0 text-sm md:text-base">Dashboard</p>
                </div>
            </div>
        </div>

        <!-- Step 1: Produk & Volume Produksi -->
        <section id="step-1" class="form-section active">
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Langkah 1: Tentukan Produk Utama</h2>
                <div id="product-list"></div>
                <button onclick="addProduct()" class="mt-4 w-full bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition">
                    + Tambah Produk Utama
                </button>
                
                <div class="mt-8 pt-6 border-t">
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Produk Sampingan (By Product)</h3>
                    <p class="text-sm text-gray-600 mb-4">Masukkan produk sampingan atau tambahan yang nilainya akan mengurangi total biaya produksi.</p>
                    <div id="additional-product-list"></div>
                    <button onclick="addAdditionalProduct()" class="mt-4 w-full bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition">
                        + Tambah Produk Tambahan
                    </button>
                </div>
            </div>
        </section>

        <!-- Step 2: Biaya Langsung & Overhead -->
        <section id="step-2" class="form-section">
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Langkah 2: Input Biaya Produksi</h2>
                
                <!-- Biaya Langsung per Produk -->
                <div id="direct-cost-container">
                    <!-- Dinamis diisi oleh JS -->
                </div>

                <!-- Biaya Overhead Pabrik (BOP) -->
                <div class="mt-8 pt-6 border-t">
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Biaya Overhead Pabrik (BOP)</h3>
                    <p class="text-sm text-gray-600 mb-4">Masukkan biaya bersama yang tidak bisa dibebankan langsung ke produk.</p>
                    <div id="bop-list" class="space-y-4"></div>
                    <button onclick="addBOP()" class="mt-4 w-full bg-purple-100 text-purple-700 font-semibold py-2 px-4 rounded-lg hover:bg-purple-200 transition">
                        + Tambah Aktivitas BOP
                    </button>
                </div>
            </div>
        </section>


        <!-- Step 3: Alokasi Biaya Overhead -->
        <section id="step-3" class="form-section">
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Langkah 3: Alokasikan Biaya Overhead Pabrik (BOP)</h2>
                <p class="text-sm text-gray-600 mb-4">Isi berapa banyak sumber daya BOP yang dikonsumsi oleh <strong>satu unit</strong> dari setiap produk.</p>
                <div id="allocation-table-container" class="overflow-x-auto"></div>
            </div>
        </section>

        <!-- Step 4: Dashboard -->
        <section id="step-4" class="form-section">
             <div class="card">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-semibold">Hasil Akhir: Dashboard HPP</h2>
                    <button onclick="downloadExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 7.414V13a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                        Unduh Excel
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="text-sm font-semibold text-green-800">TOTAL BIAYA PRODUKSI (NETO)</h4>
                        <p id="dashboard-total-cost" class="text-2xl font-bold text-green-900">Rp 0</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="text-sm font-semibold text-blue-800">JUMLAH UNIT PRODUKSI</h4>
                        <p id="dashboard-total-units" class="text-2xl font-bold text-blue-900">0</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="text-sm font-semibold text-yellow-800">HPP RATA-RATA</h4>
                        <p id="dashboard-avg-hpp" class="text-2xl font-bold text-yellow-900">Rp 0</p>
                    </div>
                </div>

                <div id="cost-structure-section" class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Struktur Biaya Produksi</h3>
                    <div id="cost-structure-chart" class="space-y-4 p-4 bg-gray-50 rounded-lg"></div>
                </div>

                <div id="hpp-comparison-section" class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Perbandingan HPP per Unit Produk</h3>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <canvas id="hpp-comparison-chart"></canvas>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Laporan Harga Pokok Produksi</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">BBB/Unit</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">BTKL/Unit</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">BOP/Unit</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">HPP/Unit</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Biaya Produk</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
             </div>
        </section>

        <!-- Navigation Buttons -->
        <div class="mt-8 flex justify-between">
            <button id="prev-btn" onclick="navigate(-1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition" style="display: none;">Kembali</button>
            <button id="next-btn" onclick="navigate(1)" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition ml-auto">Lanjut</button>
        </div>
         <div class="mt-4 text-center">
            <button onclick="resetCalculator()" class="text-sm text-gray-500 hover:text-red-600">Reset Kalkulator</button>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }
        });

        let currentStep = 1;
        let calculatorData = {};
        let hppChart = null;

        function getInitialData() {
            return {
                products: [],
                additionalProducts: [],
                bop: [],
                allocations: {}
            };
        }
        
        // --- STEP 1: PRODUK ---
        function renderProducts() {
            const list = document.getElementById('product-list');
            if (calculatorData.products.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada produk utama. Silakan tambahkan.</p>';
            } else {
                list.innerHTML = calculatorData.products.map(p => `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2 items-center p-2 border-b" id="product-${p.id}">
                        <input type="text" value="${p.name}" onchange="updateProduct(${p.id}, 'name', this.value)" placeholder="Nama Produk" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                        <input type="number" value="${p.volume || ''}" onchange="updateProduct(${p.id}, 'volume', this.value)" placeholder="Volume Produksi" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                        <button onclick="removeProduct(${p.id})" class="bg-red-100 text-red-700 px-3 py-2 rounded-md hover:bg-red-200 transition text-sm">Hapus</button>
                    </div>
                `).join('');
            }
            renderDirectCosts(); // Re-render step 2 if products change
        }

        function addProduct() {
            const newId = (calculatorData.products.length > 0 ? Math.max(...calculatorData.products.map(p => p.id)) : 0) + 1;
            calculatorData.products.push({ id: newId, name: '', volume: 0, bbbs: [], btkls: [] });
            calculatorData.allocations[newId] = {};
            renderProducts();
        }

        function removeProduct(id) {
            calculatorData.products = calculatorData.products.filter(p => p.id !== id);
            delete calculatorData.allocations[id];
            renderProducts();
        }

        function updateProduct(id, field, value) {
            const product = calculatorData.products.find(p => p.id === id);
            if (product) {
                product[field] = (field === 'name') ? value : parseFloat(value) || 0;
            }
             if (field === 'name') {
                renderDirectCosts(); // Re-render product names in Step 2
            }
        }
        
        function renderAdditionalProducts() {
            const list = document.getElementById('additional-product-list');
            if (calculatorData.additionalProducts.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada produk tambahan.</p>';
                return;
            }
            list.innerHTML = calculatorData.additionalProducts.map(p => `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-2 items-center p-2 border-b" id="add-product-${p.id}">
                    <input type="text" value="${p.name}" onchange="updateAdditionalProduct(${p.id}, 'name', this.value)" placeholder="Nama Produk Tambahan" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <input type="number" value="${p.quantity || ''}" onchange="updateAdditionalProduct(${p.id}, 'quantity', this.value)" placeholder="Jumlah" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <input type="number" value="${p.price || ''}" onchange="updateAdditionalProduct(${p.id}, 'price', this.value)" placeholder="Harga per Unit (Rp)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <button onclick="removeAdditionalProduct(${p.id})" class="bg-red-100 text-red-700 px-3 py-2 rounded-md hover:bg-red-200 transition text-sm">Hapus</button>
                </div>
            `).join('');
        }

        function addAdditionalProduct() {
            const newId = (calculatorData.additionalProducts.length > 0 ? Math.max(...calculatorData.additionalProducts.map(p => p.id)) : 0) + 1;
            calculatorData.additionalProducts.push({ id: newId, name: '', quantity: 0, price: 0 });
            renderAdditionalProducts();
        }

        function removeAdditionalProduct(id) {
            calculatorData.additionalProducts = calculatorData.additionalProducts.filter(p => p.id !== id);
            renderAdditionalProducts();
        }

        function updateAdditionalProduct(id, field, value) {
            const product = calculatorData.additionalProducts.find(p => p.id === id);
            if (product) {
                product[field] = (field === 'name') ? value : parseFloat(value) || 0;
            }
        }

        // --- STEP 2: BIAYA ---
        function renderDirectCosts() {
            const container = document.getElementById('direct-cost-container');
            if (calculatorData.products.length === 0) {
                 container.innerHTML = '<p class="text-center text-gray-500 py-4">Silakan tambahkan produk di Langkah 1 untuk mulai menginput biaya langsung.</p>';
                 renderBOP();
                 return;
            }

            container.innerHTML = calculatorData.products.map(p => {
                const bbbHtml = p.bbbs.map(b => `
                    <div class="p-2 border-b grid grid-cols-1 md:grid-cols-5 gap-2 items-center">
                        <input type="text" value="${b.name}" onchange="updateDirectCost(${p.id}, 'bbb', ${b.id}, 'name', this.value)" placeholder="Nama Bahan Baku" class="col-span-1 md:col-span-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
                        <input type="number" value="${b.price || ''}" onchange="updateDirectCost(${p.id}, 'bbb', ${b.id}, 'price', this.value)" placeholder="Harga Satuan" class="col-span-1 md:col-span-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
                        <input type="number" value="${b.qty || ''}" onchange="updateDirectCost(${p.id}, 'bbb', ${b.id}, 'qty', this.value)" placeholder="Jumlah" class="col-span-1 md:col-span-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
                        <input type="text" value="${b.unit}" onchange="updateDirectCost(${p.id}, 'bbb', ${b.id}, 'unit', this.value)" placeholder="Satuan" class="col-span-1 md:col-span-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
                        <button onclick="removeDirectCost(${p.id}, 'bbb', ${b.id})" class="bg-red-50 text-red-600 px-2 py-1 rounded-md hover:bg-red-100 transition text-xs">Hapus</button>
                    </div>
                `).join('');
                
                // MODIFIED: Added unit input and changed placeholders for BTKL
                const btklHtml = p.btkls.map(b => `
                     <div class="p-2 border-b grid grid-cols-1 md:grid-cols-5 gap-2 items-center">
                        <input type="text" value="${b.name}" onchange="updateDirectCost(${p.id}, 'btkl', ${b.id}, 'name', this.value)" placeholder="Jenis Pekerjaan" class="col-span-1 md:col-span-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
                        <input type="number" value="${b.rate || ''}" onchange="updateDirectCost(${p.id}, 'btkl', ${b.id}, 'rate', this.value)" placeholder="Tarif Upah" class="col-span-1 md:col-span-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
                        <input type="number" value="${b.hours || ''}" onchange="updateDirectCost(${p.id}, 'btkl', ${b.id}, 'hours', this.value)" placeholder="Jumlah" class="col-span-1 md:col-span-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
                        <input type="text" value="${b.unit || ''}" onchange="updateDirectCost(${p.id}, 'btkl', ${b.id}, 'unit', this.value)" placeholder="Satuan (mis. Jam)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
                        <button onclick="removeDirectCost(${p.id}, 'btkl', ${b.id})" class="bg-red-50 text-red-600 px-2 py-1 rounded-md hover:bg-red-100 transition text-xs">Hapus</button>
                    </div>
                `).join('');

                return `
                <div class="product-cost-card">
                    <h4 class="text-lg font-bold text-green-800 mb-3">${p.name || 'Produk Belum Bernama'}</h4>
                    
                    <!-- BBB Section -->
                    <div class="mb-4">
                        <h5 class="font-semibold text-md text-gray-600 mb-2">Biaya Bahan Baku (BBB)</h5>
                        <div class="space-y-2" id="bbb-list-${p.id}">${bbbHtml}</div>
                        <button onclick="addDirectCost(${p.id}, 'bbb')" class="mt-2 w-full bg-green-50 text-green-700 font-semibold py-1 px-3 rounded-lg hover:bg-green-100 transition text-sm">+ Tambah Bahan Baku</button>
                    </div>

                    <!-- BTKL Section -->
                    <div>
                        <h5 class="font-semibold text-md text-gray-600 mb-2">Biaya Tenaga Kerja Langsung (BTKL)</h5>
                        <div class="space-y-2" id="btkl-list-${p.id}">${btklHtml}</div>
                         <button onclick="addDirectCost(${p.id}, 'btkl')" class="mt-2 w-full bg-green-50 text-green-700 font-semibold py-1 px-3 rounded-lg hover:bg-green-100 transition text-sm">+ Tambah Pekerjaan</button>
                    </div>
                </div>
                `
            }).join('');
            renderBOP();
        }
        
        function addDirectCost(productId, type) {
            const product = calculatorData.products.find(p => p.id === productId);
            if (!product) return;

            if (type === 'bbb') {
                const newId = (product.bbbs.length > 0 ? Math.max(...product.bbbs.map(b => b.id)) : 0) + 1;
                product.bbbs.push({ id: newId, name: '', price: 0, qty: 0, unit: '' });
            } else if (type === 'btkl') {
                const newId = (product.btkls.length > 0 ? Math.max(...product.btkls.map(b => b.id)) : 0) + 1;
                // MODIFIED: Added 'unit' property for new BTKL items
                product.btkls.push({ id: newId, name: '', rate: 0, hours: 0, unit: '' });
            }
            renderDirectCosts();
        }

        function removeDirectCost(productId, type, costId) {
            const product = calculatorData.products.find(p => p.id === productId);
            if (!product) return;

            if (type === 'bbb') {
                product.bbbs = product.bbbs.filter(b => b.id !== costId);
            } else if (type === 'btkl') {
                 product.btkls = product.btkls.filter(b => b.id !== costId);
            }
            renderDirectCosts();
        }

        function updateDirectCost(productId, type, costId, field, value) {
            const product = calculatorData.products.find(p => p.id === productId);
            if (!product) return;
            
            const list = type === 'bbb' ? product.bbbs : product.btkls;
            const item = list.find(i => i.id === costId);
            if (item) {
                 item[field] = ['name', 'unit'].includes(field) ? value : parseFloat(value) || 0;
            }
        }

        function renderBOP() {
            const bopList = document.getElementById('bop-list');
             if (calculatorData.bop.length === 0) {
                bopList.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada aktivitas BOP.</p>';
            } else {
                bopList.innerHTML = calculatorData.bop.map(b => `
                    <div class="p-4 border rounded-lg" id="bop-${b.id}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" value="${b.name}" onchange="updateBOP(${b.id}, 'name', this.value)" placeholder="Nama Aktivitas BOP" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                            <input type="number" value="${b.cost || ''}" onchange="updateBOP(${b.id}, 'cost', this.value)" placeholder="Total Biaya (Rp)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                            <input type="text" value="${b.driverName}" onchange="updateBOP(${b.id}, 'driverName', this.value)" placeholder="Nama Cost Driver" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                            <input type="number" value="${b.driverUnits || ''}" onchange="updateBOP(${b.id}, 'driverUnits', this.value)" placeholder="Jumlah Cost Driver" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                        </div>
                         <button onclick="removeBOP(${b.id})" class="mt-2 text-xs text-red-500 hover:text-red-700">Hapus Aktivitas</button>
                    </div>
                `).join('');
            }
        }
        
        function addBOP() {
            const newId = (calculatorData.bop.length > 0 ? Math.max(...calculatorData.bop.map(b => b.id)) : 0) + 1;
            calculatorData.bop.push({ id: newId, name: '', cost: 0, driverName: '', driverUnits: 0 });
            renderBOP();
        }

        function removeBOP(id) {
            calculatorData.bop = calculatorData.bop.filter(b => b.id !== id);
            Object.values(calculatorData.allocations).forEach(alloc => { delete alloc[id]; });
            renderBOP();
        }

        function updateBOP(id, field, value) {
            const bop = calculatorData.bop.find(b => b.id === id);
            if (bop) {
                bop[field] = ['name', 'driverName'].includes(field) ? value : parseFloat(value) || 0;
            }
        }

        // --- STEP 3: ALOKASI BOP ---
        function renderAllocationTable() {
            const container = document.getElementById('allocation-table-container');
            if (calculatorData.products.length === 0 || calculatorData.bop.length === 0) {
                 container.innerHTML = '<p class="text-center text-gray-500 py-4">Silakan tambahkan produk (Langkah 1) dan biaya BOP (Langkah 2) terlebih dahulu.</p>';
                return;
            }
            
            let header = `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>`;
            calculatorData.bop.forEach(b => {
                header += `<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="${b.name}">${b.driverName || 'Driver BOP'} / unit</th>`;
            });

            let body = '';
            calculatorData.products.forEach(p => {
                let row = `<td class="px-4 py-4 whitespace-nowrap font-medium text-gray-900">${p.name || `Produk #${p.id}`}</td>`;
                const alloc = calculatorData.allocations[p.id] || {};
                
                calculatorData.bop.forEach(b => {
                    const bopAlloc = alloc[b.id] || 0;
                    row += `<td><input type="number" step="any" value="${bopAlloc || ''}" onchange="updateAllocation(${p.id}, ${b.id}, this.value)" placeholder="0" class="w-24 mx-auto block rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-center"></td>`;
                });

                body += `<tr class="border-b">${row}</tr>`;
            });

            container.innerHTML = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>${header}</tr></thead><tbody class="bg-white divide-y divide-gray-200">${body}</tbody></table>`;
        }

        function updateAllocation(productId, bopId, value) {
            const val = parseFloat(value) || 0;
            if (!calculatorData.allocations[productId]) {
                calculatorData.allocations[productId] = {};
            }
            calculatorData.allocations[productId][bopId] = val;
        }
        
        // --- STEP 4: DASHBOARD & KALKULASI ---
        function calculateHPP() {
            const results = [];
            const totalProductionUnits = calculatorData.products.reduce((sum, p) => sum + (p.volume || 0), 0);

            const bopRates = {};
            calculatorData.bop.forEach(b => {
                bopRates[b.id] = (b.driverUnits > 0) ? b.cost / b.driverUnits : 0;
            });

            let totalBBB = 0;
            let totalBTKL = 0;
            let totalBOP = 0;

            for (const product of calculatorData.products) {
                const productVolume = product.volume || 0;

                // Calculate direct costs for this product
                const totalBBBForProduct = product.bbbs.reduce((sum, bbb) => sum + ((bbb.price || 0) * (bbb.qty || 0)), 0);
                const totalBTKLForProduct = product.btkls.reduce((sum, btkl) => sum + ((btkl.rate || 0) * (btkl.hours || 0)), 0);

                const bbbPerUnit = productVolume > 0 ? totalBBBForProduct / productVolume : 0;
                const btklPerUnit = productVolume > 0 ? totalBTKLForProduct / productVolume : 0;
                
                // Calculate allocated BOP for this product
                let bopPerUnit = 0;
                const productAllocations = calculatorData.allocations[product.id] || {};
                calculatorData.bop.forEach(b => {
                    const consumption = productAllocations[b.id] || 0;
                    bopPerUnit += consumption * bopRates[b.id];
                });

                const hppPerUnit = bbbPerUnit + btklPerUnit + bopPerUnit;
                const totalCostForProduct = hppPerUnit * productVolume;

                results.push({
                    name: product.name,
                    volume: productVolume,
                    bbbPerUnit,
                    btklPerUnit,
                    bopPerUnit,
                    hppPerUnit,
                    totalCost: totalCostForProduct
                });
                
                totalBBB += totalBBBForProduct;
                totalBTKL += totalBTKLForProduct;
                totalBOP += bopPerUnit * productVolume;
            }
            
            const grossTotalProductionCost = totalBBB + totalBTKL + totalBOP;
            
            const additionalProductsValue = calculatorData.additionalProducts.reduce((sum, p) => {
                return sum + ((p.quantity || 0) * (p.price || 0));
            }, 0);
            const netTotalProductionCost = grossTotalProductionCost - additionalProductsValue;

            const avgHpp = totalProductionUnits > 0 ? netTotalProductionCost / totalProductionUnits : 0;
            
            const bbbPercentage = (grossTotalProductionCost > 0) ? (totalBBB / grossTotalProductionCost) * 100 : 0;
            const btklPercentage = (grossTotalProductionCost > 0) ? (totalBTKL / grossTotalProductionCost) * 100 : 0;
            const bopPercentage = (grossTotalProductionCost > 0) ? (totalBOP / grossTotalProductionCost) * 100 : 0;

            return { 
                results, 
                totalProductionCost: netTotalProductionCost,
                grossTotalProductionCost,
                additionalProductsValue,
                totalProductionUnits, 
                avgHpp,
                costStructure: { 
                    totalBBB, 
                    totalBTKL, 
                    totalBOP, 
                    bbbPercentage, 
                    btklPercentage, 
                    bopPercentage 
                }
            };
        }
        
        function renderDashboard() {
            const { results, totalProductionCost, totalProductionUnits, avgHpp, costStructure } = calculateHPP();
            const formatCurrency = (value) => `Rp ${value.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            document.getElementById('dashboard-total-cost').textContent = formatCurrency(totalProductionCost);
            document.getElementById('dashboard-total-units').textContent = totalProductionUnits.toLocaleString('id-ID');
            document.getElementById('dashboard-avg-hpp').textContent = formatCurrency(avgHpp);

            const tableBody = document.getElementById('dashboard-table-body');
            tableBody.innerHTML = results.map(r => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${r.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${formatCurrency(r.bbbPerUnit)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${formatCurrency(r.btklPerUnit)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${formatCurrency(r.bopPerUnit)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right font-bold text-green-600">${formatCurrency(r.hppPerUnit)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${formatCurrency(r.totalCost)}</td>
                </tr>
            `).join('');

            const chartContainer = document.getElementById('cost-structure-chart');
            if (costStructure.totalBBB + costStructure.totalBTKL + costStructure.totalBOP > 0) {
                chartContainer.innerHTML = `
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-blue-700">Biaya Bahan Baku (BBB)</span>
                        <span class="text-sm font-medium text-blue-700">${costStructure.bbbPercentage.toFixed(2)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-blue-600 h-4 rounded-full" style="width: ${costStructure.bbbPercentage}%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-orange-700">Biaya Tenaga Kerja (BTKL)</span>
                        <span class="text-sm font-medium text-orange-700">${costStructure.btklPercentage.toFixed(2)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-orange-500 h-4 rounded-full" style="width: ${costStructure.btklPercentage}%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-red-700">Biaya Overhead (BOP)</span>
                        <span class="text-sm font-medium text-red-700">${costStructure.bopPercentage.toFixed(2)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-red-600 h-4 rounded-full" style="width: ${costStructure.bopPercentage}%"></div>
                    </div>
                </div>
                `;
            } else {
                chartContainer.innerHTML = '<p class="text-center text-gray-500">Data biaya belum cukup untuk menampilkan struktur biaya.</p>';
            }

            const chartCanvas = document.getElementById('hpp-comparison-chart').getContext('2d');
            const productLabels = results.map(r => r.name);
            const hppData = results.map(r => r.hppPerUnit);

            if (hppChart) {
                hppChart.destroy(); 
            }

            hppChart = new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: productLabels,
                    datasets: [{
                        label: 'HPP per Unit (Rp)',
                        data: hppData,
                        backgroundColor: [
                            'rgba(22, 163, 74, 0.6)', 'rgba(37, 99, 235, 0.6)',
                            'rgba(217, 119, 6, 0.6)','rgba(220, 38, 38, 0.6)',
                            'rgba(107, 114, 128, 0.6)'
                        ],
                        borderColor: [
                            'rgba(22, 163, 74, 1)','rgba(37, 99, 235, 1)',
                            'rgba(217, 119, 6, 1)','rgba(220, 38, 38, 1)',
                            'rgba(107, 114, 128, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` HPP: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return 'Rp ' + value.toLocaleString('id-ID');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- NAVIGASI & INIT ---
        function navigate(direction) {
            const newStep = currentStep + direction;
            if (newStep < 1 || newStep > 4) return;

            if (direction > 0) {
                 if (currentStep === 1) { renderDirectCosts(); }
                 if (currentStep === 2) { renderAllocationTable(); }
                 if (currentStep === 3) { renderDashboard(); }
            }

            document.getElementById(`step-${currentStep}`).classList.remove('active');
            if (direction > 0) {
                document.getElementById(`step-indicator-${currentStep}`).classList.add('completed');
                document.getElementById(`step-indicator-${currentStep}`).classList.remove('active');
            } else {
                 document.getElementById(`step-indicator-${currentStep-1}`).classList.remove('completed');
            }

            currentStep = newStep;
            document.getElementById(`step-1`).classList.remove('active');
            document.getElementById(`step-2`).classList.remove('active');
            document.getElementById(`step-3`).classList.remove('active');
            document.getElementById(`step-4`).classList.remove('active');
            document.getElementById(`step-${currentStep}`).classList.add('active');
            document.getElementById(`step-indicator-${currentStep}`).classList.add('active');
            updateNavButtons();
        }

        function updateNavButtons() {
            document.getElementById('prev-btn').style.display = (currentStep > 1) ? 'block' : 'none';
            document.getElementById('next-btn').style.display = (currentStep < 4) ? 'block' : 'none';
        }

        function updateStepIndicators() {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step-indicator-${i}`);
                indicator.classList.remove('active', 'completed');
                if (i < currentStep) {
                    indicator.classList.add('completed');
                } else if (i === currentStep) {
                    indicator.classList.add('active');
                }
            }
        }
        
        function resetCalculator() {
            // Menghapus confirm() karena tidak berfungsi baik di beberapa environment
            currentStep = 1;
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById('step-1').classList.add('active');
            initialize(true);
            updateStepIndicators();
            updateNavButtons();
        }
        
        function initialize(isReset = false) {
            calculatorData = getInitialData();
            
            if (isReset || calculatorData.products.length === 0) {
                addProduct();
                addAdditionalProduct();
                addBOP();
            }
            renderProducts();
            renderAdditionalProducts();
            renderDirectCosts();
        }

        // --- EXCEL EXPORT ---
        function downloadExcel() {
            const calculatedData = calculateHPP();
            
            if (calculatedData.results.length === 0) {
                console.error("Tidak ada data untuk diunduh.");
                return;
            }

            const { results, totalProductionCost, grossTotalProductionCost, additionalProductsValue, totalProductionUnits, avgHpp, costStructure } = calculatedData;

            // --- Define Styles ---
            const titleStyle = { font: { name: 'Calibri', sz: 16, bold: true }, alignment: { horizontal: 'center', vertical: 'center' } };
            const sectionHeaderStyle = { font: { name: 'Calibri', sz: 12, bold: true, color: { rgb: "000000" } }, fill: { fgColor: { rgb: "D9D2E9" } }, alignment: { horizontal: 'center', vertical: 'center' } };
            const columnHeaderStyle = { font: { name: 'Calibri', sz: 11, bold: true }, alignment: { horizontal: 'center', vertical: 'center' }, border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } } };
            const dataCellStyle = { border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } }, alignment: { vertical: 'center' } };
            const centeredDataCellStyle = { ...dataCellStyle, alignment: { horizontal: 'center', vertical: 'center' } };
            const labelCellStyle = { ...dataCellStyle, font: { bold: false } };
            const boldLabelCellStyle = { ...dataCellStyle, font: { bold: true } };
            const boldDataCellStyle = { ...dataCellStyle, font: { bold: true } };

            // --- Define Number Formats ---
            const rpFormat = 'Rp#,##0.00';
            const unitFormat = '#,##0';
            const percentFormat = '0.00%';
            const rpParenthesesFormat = 'Rp#,##0.00;"(Rp"#,##0.00")"';

            // --- Prepare Data ---
             const ws_data = [
                [], // Row 1 (empty)
                ['', 'HASIL AKHIR PERHITUNGAN HARGA POKOK PRODUKSI'], 
                [], 
                ['', 'Total Biaya Produksi (Bruto)', grossTotalProductionCost], 
                ['', 'Pengurang Biaya (Produk Tambahan)', -additionalProductsValue], 
                ['', 'TOTAL BIAYA PRODUKSI (Neto)', totalProductionCost], 
                ['', 'JUMLAH UNIT PRODUKSI', totalProductionUnits], 
                ['', 'HPP RATA-RATA (Neto)', avgHpp], 
                [], [], 
                ['', 'STRUKTUR BIAYA PRODUKSI'], 
                ['', 'Komponen Biaya', 'Total Biaya', 'Persentase'], 
                ['', 'Biaya Bahan Baku (BBB)', costStructure.totalBBB, costStructure.bbbPercentage / 100], 
                ['', 'Biaya Tenaga Kerja (BTKL)', costStructure.totalBTKL, costStructure.btklPercentage / 100], 
                ['', 'Biaya Overhead (BOP)', costStructure.totalBOP, costStructure.bopPercentage / 100], 
                ['', 'Total Biaya (Bruto)', grossTotalProductionCost, 1],
                [], [], 
                ['', 'LAPORAN HARGA POKOK PRODUKSI'], 
                ['', 'Produk', 'Volume', 'BBB/Unit', 'BTKL/Unit', 'BOP/Unit', 'HPP/Unit', 'Total Biaya']
            ];
            
            results.forEach(r => {
                ws_data.push(['', r.name, r.volume, r.bbbPerUnit, r.btklPerUnit, r.bopPerUnit, r.hppPerUnit, r.totalCost]);
            });
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // --- Apply Merges & Column Widths ---
            ws['!cols'] = [ { wch: 2 }, { wch: 35 }, { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 } ];
            ws['!merges'] = [
                { s: { r: 1, c: 1 }, e: { r: 1, c: 7 } }, 
                { s: { r: 10, c: 1 }, e: { r: 10, c: 3 } }, 
                // FIX: Corrected row index for merge from 17 to 18
                { s: { r: 18, c: 1 }, e: { r: 18, c: 7 } }  
            ];

            // --- Apply Styles & Formats ---
            if (ws['B2']) ws['B2'].s = titleStyle;
            if (ws['B11']) ws['B11'].s = sectionHeaderStyle;
            // FIX: Corrected cell reference from B18 to B19
            if (ws['B19']) ws['B19'].s = sectionHeaderStyle;

            ['B12', 'C12', 'D12'].forEach(key => { if(ws[key]) ws[key].s = columnHeaderStyle; });
            // FIX: Corrected row from 19 to 20
            ['B20', 'C20', 'D20', 'E20', 'F20', 'G20', 'H20'].forEach(key => { if(ws[key]) ws[key].s = columnHeaderStyle; });

            // Summary
            for (let R = 3; R <= 7; ++R) {
                 const b_cell_ref = `B${R+1}`;
                 const c_cell_ref = `C${R+1}`;
                 if(ws[b_cell_ref]) ws[b_cell_ref].s = (R === 5 || R === 7) ? boldLabelCellStyle : labelCellStyle;
                 if(ws[c_cell_ref]) ws[c_cell_ref].s = (R === 5 || R === 7) ? boldDataCellStyle : dataCellStyle;
            }
            if(ws['C4']) ws['C4'].z = rpFormat;
            if(ws['C5']) ws['C5'].z = rpParenthesesFormat;
            if(ws['C6']) ws['C6'].z = rpFormat;
            if(ws['C7']) ws['C7'].z = unitFormat;
            if(ws['C8']) ws['C8'].z = rpFormat;
            
            // Cost Structure
            for (let R = 12; R <= 15; ++R) {
                const b_cell_ref = `B${R+1}`;
                const c_cell_ref = `C${R+1}`;
                const d_cell_ref = `D${R+1}`;
                if(ws[b_cell_ref]) ws[b_cell_ref].s = R === 15 ? boldLabelCellStyle : labelCellStyle;
                if(ws[c_cell_ref]) { ws[c_cell_ref].s = R === 15 ? boldDataCellStyle : dataCellStyle; ws[c_cell_ref].z = rpFormat; }
                if(ws[d_cell_ref]) { ws[d_cell_ref].s = dataCellStyle; ws[d_cell_ref].z = percentFormat; }
            }

            // Report Table
            // FIX: Corrected start row from 20 to 21
            results.forEach((r, index) => {
                const row = 21 + index;
                if(ws[`B${row}`]) ws[`B${row}`].s = labelCellStyle;
                if(ws[`C${row}`]) { ws[`C${row}`].s = centeredDataCellStyle; ws[`C${row}`].z = unitFormat; }
                if(ws[`D${row}`]) { ws[`D${row}`].s = dataCellStyle; ws[`D${row}`].z = rpFormat; }
                if(ws[`E${row}`]) { ws[`E${row}`].s = dataCellStyle; ws[`E${row}`].z = rpFormat; }
                if(ws[`F${row}`]) { ws[`F${row}`].s = dataCellStyle; ws[`F${row}`].z = rpFormat; }
                if(ws[`G${row}`]) { ws[`G${row}`].s = boldDataCellStyle; ws[`G${row}`].z = rpFormat; }
                if(ws[`H${row}`]) { ws[`H${row}`].s = dataCellStyle; ws[`H${row}`].z = rpFormat; }
            });

            // --- Create and Download Workbook ---
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan HPP");
            XLSX.writeFile(wb, "Laporan_HPP.xlsx");
        }

        window.onload = initialize;
    </script>
</body>
</html>
